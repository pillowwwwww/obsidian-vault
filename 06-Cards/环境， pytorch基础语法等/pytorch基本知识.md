---
Title: pytorchåŸºæœ¬çŸ¥è¯†
tags: 
åŸå§‹é“¾æ¥:
---
è®°å¾—çœ‹google colab ç¬”è®°ï¼š 
00ã€01ã€02ã€03
https://colab.research.google.com/drive/13-KqUlaOSNPHa-hJGtZHMDtRBgSXDpvh
## PyTorch Tensoråˆ†ç±»

| åç§°     | ç»´åº¦  | æ•°å­¦å«ä¹‰      | ç¤ºä¾‹                         | Shape          | å¸¸è§ç”¨é€”          |
| ------ | --- | --------- | -------------------------- | -------------- | ------------- |
| **æ ‡é‡** | 0   | å•ä¸ªæ•°å€¼      | `tensor(42)`               | `()`           | æŸå¤±å€¼ã€è¶…å‚æ•°       |
| **å‘é‡** | 1   | ä¸€ç»´æ•°ç»„      | `tensor([1, 2, 3])`        | `(n,)`         | ç‰¹å¾å‘é‡ã€åç½®é¡¹      |
| **çŸ©é˜µ** | 2   | äºŒç»´æ•°ç»„ï¼ˆè¡ŒÃ—åˆ—ï¼‰ | `tensor([[1, 2], [3, 4]])` | `(m, n)`       | æƒé‡çŸ©é˜µã€ç°åº¦å›¾åƒ     |
| **å¼ é‡** | â‰¥3  | å¤šç»´æ•°ç»„      | `torch.randn(2, 3, 4)`     | `(d1, d2,...)` | æ‰¹é‡æ•°æ®ã€RGBå›¾åƒã€è§†é¢‘ |
#### å…³é”®è¯´æ˜
1. **ç»´åº¦**ï¼šé€šè¿‡ `tensor.ndim` æˆ– `len(tensor.shape)` è·å–  
2. **æ ‡é‡ç‰¹æ®Šç‚¹**ï¼š
   - PyTorch ä¸­scalaræ˜¯ 0 ç»´ï¼ˆæ•°å­¦ä¸­å¯èƒ½è§†ä¸º 1 ç»´ï¼‰
   - éœ€ç”¨ `item()` æå– Python æ•°å€¼ï¼š`scalar.item()`
3. **é«˜ç»´å¼ é‡å‘½å**ï¼š
   - 3ç»´ï¼šé€šå¸¸ç§° "3D å¼ é‡"ï¼ˆå¦‚æ—¶åºæ•°æ®ï¼‰
   - 4ç»´ï¼šå¸¸è§äºæ‰¹é‡å¤„ç†ï¼ˆå¦‚ `(batch, channel, height, width)`ï¼‰

#### ç¤ºä¾‹ä»£ç 
```python
import torch

# å„ç»´åº¦å¼ é‡åˆ›å»º
scalar = torch.tensor(42)                    # æ ‡é‡
vector = torch.arange(3)                     # å‘é‡
matrix = torch.ones(2, 2)                    # çŸ©é˜µ
tensor_3d = torch.rand(2, 3, 4)              # 3ç»´å¼ é‡

# ç»´åº¦éªŒè¯
assert scalar.ndim == 0
assert vector.shape == (3,)
```

### çº¿æ€§æ¨¡å‹Linear
#### `nn.Linear` çš„æœ¬è´¨
- `nn.Linear(in_features, out_features)` è¡¨ç¤ºå¯¹è¾“å…¥æ•°æ®åšä¸€æ¬¡ **çº¿æ€§å˜æ¢**
- æ•°å­¦è¡¨è¾¾ï¼š`output = weight Ã— input + bias`
- å®ƒåªè¿›è¡ŒåŠ å‡ä¹˜é™¤æ“ä½œï¼Œæ²¡æœ‰å¼•å…¥ä»»ä½•éçº¿æ€§å‡½æ•°

#### çº¿æ€§æ¨¡å‹åªèƒ½å­¦åˆ°çº¿æ€§çš„å…³ç³»

çº¿æ€§æ¨¡å‹åªèƒ½å­¦åˆ° **çº¿æ€§çš„å…³ç³»** ï¼Œæ¯”å¦‚ï¼š
- åˆ†ç±»ä»»åŠ¡ä¸­ï¼šä¸€æ¡ç›´çº¿ï¼ˆ2Dï¼‰ã€ä¸€ä¸ªå¹³é¢ï¼ˆ3Dï¼‰ã€ä¸€ä¸ªè¶…å¹³é¢ï¼ˆé«˜ç»´ï¼‰
- å›å½’ä»»åŠ¡ä¸­ï¼šè¾“å…¥å’Œè¾“å‡ºä¹‹é—´çš„çº¿æ€§å…³ç³»
- ä¸¾ä¸ªä¾‹å­ï¼š
	`model = nn.Linear(2, 1)`
	è¿™ä¸ªæ¨¡å‹å¯ä»¥è§£å†³è¿™æ ·çš„é—®é¢˜ï¼š
	- ç»™ä½ ä¸€ä¸ªç‚¹ `(x1, x2)`ï¼Œé¢„æµ‹å®ƒæ˜¯åœ¨çº¿çš„å“ªä¸€è¾¹
	ä½†å®ƒæ— æ³•è§£å†³åƒåœ†ä¸€æ ·çš„é—®é¢˜ï¼Œå› ä¸ºåœ†çš„è¾¹ç•Œæ˜¯æ›²çº¿ï¼Œä¸æ˜¯ç›´çº¿ï¼
#### è¦æ¨¡å‹å­¦åˆ°æ›²çº¿ï¼Œå°±è¦åœ¨æ¨¡å‹ä¸­åŠ å…¥ **éçº¿æ€§æˆåˆ†**

#### ä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥å†™ model_0(X_test) æ¥æ‰§è¡Œå‰å‘ä¼ æ’­ï¼Ÿ

 âœ… åŸå› ï¼š
PyTorch ä¸­çš„æ‰€æœ‰æ¨¡å‹ç±»éƒ½ç»§æ‰¿è‡ª `torch.nn.Module`ï¼Œè¿™ä¸ªåŸºç±»å®ç°äº† `__call__()` æ–¹æ³•ã€‚
```
class SimpleModel(nn.Module):
    def __init__(self):
        super().__init__()
        self.linear = nn.Linear(1, 1)

    def forward(self, x):
        print("Calling forward")
        return self.linear(x)
        

# åˆ›å»ºæ¨¡å‹
model = SimpleModel()

# è°ƒç”¨æ¨¡å‹
x = torch.tensor([[1.0]])
y = model(x)  # å®é™…ä¸Šå°±æ˜¯åœ¨è°ƒç”¨ forward()
```
####  `y_logits` å’Œ `y_pred_probs` æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ

| æ¦‚å¿µ                 | å«ä¹‰                                | ç‰¹ç‚¹                     |
| ------------------ | --------------------------------- | ---------------------- |
| **`y_logits`**     | æ¨¡å‹çš„åŸå§‹è¾“å‡ºï¼Œæœªç»è¿‡å½’ä¸€åŒ–æˆ–æ¿€æ´»å‡½æ•°å¤„ç†             | å¯ä»¥æ˜¯ä»»æ„å®æ•°ï¼ˆæ­£ã€è´Ÿã€0ï¼‰ï¼Œä¸ç›´æ¥è¡¨ç¤ºæ¦‚ç‡ |
| **`y_pred_probs`** | ç»è¿‡`sigmoid()`å‡½æ•°åçš„ç»“æœï¼Œè¡¨ç¤ºé¢„æµ‹ä¸ºç±»åˆ« 1 çš„æ¦‚ç‡ | å€¼åœ¨ [0, 1] èŒƒå›´å†…ï¼Œå¯è§£é‡Šä¸ºæ¦‚ç‡   |


# pytorchä½¿ç”¨å›¾åƒ
## åœ¨ PyTorch ä¸­ä½¿ç”¨å›¾åƒæ•°æ®ï¼Œéœ€è¦åšä»€ä¹ˆï¼Ÿ

PyTorch ä½¿ç”¨ `torchvision` æ¥å¤„ç†å›¾åƒæ•°æ®ã€‚ä½ éœ€è¦å®Œæˆä»¥ä¸‹ 4 ä¸ªæ­¥éª¤çš„â€œé€»è¾‘æµç¨‹â€ï¼š
1. **å‡†å¤‡æ•°æ®é›†**ï¼š  
    ä½¿ç”¨å¦‚ `MNIST`ã€`CIFAR10` ç­‰å†…ç½®å›¾åƒæ•°æ®é›†ï¼Œæˆ–åŠ è½½ä½ è‡ªå·±çš„å›¾ç‰‡æ•°æ®ã€‚
    
2. **é¢„å¤„ç†**ï¼š  
    æŠŠå›¾åƒè½¬æˆ PyTorch èƒ½è¯†åˆ«çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š
    - è½¬ä¸ºå¼ é‡ï¼ˆtensorï¼‰
    - æ ‡å‡†åŒ–ï¼ˆnormalizationï¼‰
    - ç¼©æ”¾æˆ–è£å‰ªï¼ˆresize/cropï¼‰    
3. **æ„å»ºæ•°æ®åŠ è½½å™¨ï¼ˆDataLoaderï¼‰**ï¼š  
    æŠŠæ•°æ®æŒ‰å°æ‰¹æ¬¡ï¼ˆbatchï¼‰ç»„ç»‡å¥½ï¼Œè‡ªåŠ¨åœ¨è®­ç»ƒæ—¶ä¸€æ‰¹æ‰¹é€å…¥æ¨¡å‹ã€‚
4. **åœ¨è®­ç»ƒä¸­ä½¿ç”¨**ï¼š  
    ä½¿ç”¨ `for` å¾ªç¯ä» DataLoader ä¸­å–å‡ºæ¯ä¸€æ‰¹æ•°æ®ï¼Œé€ç»™æ¨¡å‹è¿›è¡Œè®­ç»ƒã€‚
#### ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ `torchvision.transforms`ï¼Ÿ

æˆ‘ä»¬æ‹¿åˆ°äº†å›¾åƒæ–‡ä»¶ï¼ˆå¦‚ `.jpg`ï¼‰ï¼Œä½†åœ¨ PyTorch ä¸­ï¼Œ**æ¨¡å‹ä¸èƒ½ç›´æ¥ä½¿ç”¨å›¾ç‰‡æ–‡ä»¶**ï¼Œå¿…é¡»å°†å›¾åƒè½¬æˆï¼š

> **å¼ é‡ï¼ˆTensorï¼‰æ ¼å¼**ï¼Œä¸”å°ºå¯¸ç»Ÿä¸€ï¼Œå¹¶å¯ä»¥åšå›¾åƒå¢å¼ºï¼ˆæ¯”å¦‚éšæœºç¿»è½¬ï¼‰ã€‚

####  `DataLoader`ï¼Ÿ

**`DataLoader`** æ˜¯ PyTorch ä¸­ç”¨æ¥**æŒ‰æ‰¹æ¬¡ï¼ˆbatchï¼‰åŠ è½½æ•°æ®**çš„å·¥å…·ã€‚å®ƒçš„ä½œç”¨æ˜¯å°†åŸå§‹çš„ `Dataset`ï¼ˆå¦‚ MNISTã€CIFAR-10ï¼‰å°è£…èµ·æ¥ï¼Œå˜æˆä¸€ä¸ª**å¯è¿­ä»£å¯¹è±¡**ï¼Œæ¯æ¬¡è¿”å›ä¸€ä¸ª batch çš„æ•°æ®ã€‚
#### ä¸ºä»€ä¹ˆæœ‰ Batchï¼Ÿ
åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œ**ä¸å¯èƒ½æ¯æ¬¡ç”¨æ•´ä¸ªæ•°æ®é›†å»è®­ç»ƒä¸€è½®**ï¼Œå› ä¸ºï¼š
- é€Ÿåº¦å¤ªæ…¢ï¼›
- å ç”¨å†…å­˜è¿‡é«˜ï¼›
- ä¸åˆ©äºæ¢¯åº¦ä¸‹é™çš„ä¼˜åŒ–ç­–ç•¥ï¼ˆSGD æœ¬èº«å°±å‡è®¾æ˜¯ mini-batchï¼‰ã€‚
æ‰€ä»¥æˆ‘ä»¬å¸¸ç”¨çš„æ˜¯**Mini-Batch SGD**ï¼š
- æ¯æ¬¡ç”¨ä¸€ä¸ªå°æ‰¹é‡ï¼ˆbatchï¼‰æ¥è®­ç»ƒï¼›
- é€šå¸¸ batch å¤§å°æ˜¯ 32ã€64ã€128 ç­‰ï¼›
    
è¿™å°±æ˜¯ä½ çœ‹åˆ°çš„ï¼š
`trainloader = DataLoader(train_dataset, batch_size=64, shuffle=True)`

æ¯æ¬¡ä» `trainloader` å–å‡ºæ¥çš„å†…å®¹æ˜¯ä¸€ä¸ª batchï¼Œæœ‰ 64 å¼ å›¾å’Œ 64 ä¸ªæ ‡ç­¾ã€‚
**DataLoaderå±æ€§æ€»ç»“**
1. **æ ¸å¿ƒå±æ€§å¯¹æ¯”è¡¨**

| å±æ€§            | ä½œç”¨     | è®­ç»ƒè®¾ç½®   | æµ‹è¯•è®¾ç½®    | åŸå›             |
| ------------- | ------ | ------ | ------- | ------------- |
| `batch_size`  | æ‰¹æ¬¡å¤§å°   | 32-128 | 64-256  | æµ‹è¯•æ—¶å¯ç”¨æ›´å¤§æ‰¹æ¬¡     |
| `shuffle`     | æ•°æ®æ‰“ä¹±   | `True` | `False` | è®­ç»ƒéœ€éšæœºæ€§ï¼Œæµ‹è¯•éœ€å¯é‡ç° |
| `num_workers` | å¹¶è¡Œè¿›ç¨‹æ•°  | 2-8    | 2-8     | éƒ½éœ€è¦åŠ é€Ÿæ•°æ®åŠ è½½     |
| `drop_last`   | ä¸¢å¼ƒæœ€åæ‰¹æ¬¡ | `True` | `False` | è®­ç»ƒè¦ä¸€è‡´æ€§ï¼Œæµ‹è¯•è¦å®Œæ•´æ€§ |
| `pin_memory`  | å†…å­˜å›ºå®š   | `True` | `True`  | æœ‰GPUæ—¶éƒ½åº”å¯ç”¨     |
### ğŸ§ª ä¸€ä¸ªå®Œæ•´ä¾‹å­ï¼š

``` python 
from torchvision import datasets, transforms
from torch.utils.data import DataLoader

# åˆ›å»º Dataset
transform = transforms.ToTensor()
train_dataset = datasets.MNIST(root='./data', train=True, transform=transform, download=True)

# åˆ›å»º DataLoaderï¼ˆæŒ‰ batch=32 è¿”å›ï¼‰
trainloader = DataLoader(train_dataset, batch_size=32, shuffle=True)

# è¯»å–ä¸€ä¸ª batch çš„æ•°æ®
for batch_idx, (images, labels) in enumerate(trainloader):
    print(f"Batch {batch_idx}")
    print("Images shape:", images.shape)   # torch.Size([32, 1, 28, 28])
    print("Labels shape:", labels.shape)   # torch.Size([32])
    break
```

 âœ… æœ€åè¡¥å……ï¼šå¸¸è§å½¢çŠ¶é€ŸæŸ¥è¡¨

| æ•°æ®ä½ç½®            | ç±»å‹          | ç¤ºä¾‹å½¢çŠ¶          | è¯´æ˜             |
| --------------- | ----------- | ------------- | -------------- |
| åŸå§‹å›¾åƒ            | `PIL.Image` | `(28,28)`     | ç°åº¦å›¾åƒ           |
| `.ToTensor()` å | `Tensor`    | `(1,28,28)`   | åŠ ä¸Šé€šé“ç»´åº¦ï¼ˆ1ä¸ªç°åº¦é€šé“ï¼‰ |
| `DataLoader` è¾“å‡º | `Tensor`    | `(B,1,28,28)` | æ‰¹æ¬¡ç»´åº¦ Bï¼Œä¾‹å¦‚ 64   |
| æ ‡ç­¾              | `Tensor`    | `(B,)`        | ä¸€ç»´æ•´æ•°æ•°ç»„         |
## numpy()å’Œnp.array()æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ
`tensor.numpy()` æ˜¯ **PyTorch Tensor â†’ numpy**  ï¼Œå…±äº«å†…å­˜ï¼Œä¿®æ”¹å…¶ä¸­ä¸€ä¸ªï¼Œå¦ä¸€ä¸ªä¹Ÿä¼šå˜ï¼
`np.array(...)` æ˜¯ **æŠŠä»»ä½•ä¸œè¥¿å˜ numpy arrayï¼ˆä¸»è¦æ˜¯ list/tupleï¼‰**

| å‡½æ•°å              | æ¥è‡ªå“ªé‡Œ                     | è¾“å…¥ç±»å‹                                     | ä¸»è¦ç”¨é€”                  | æ˜¯å¦å…±äº«å†…å­˜   | ç¤ºä¾‹                            |
| ---------------- | ------------------------ | ---------------------------------------- | --------------------- | -------- | ----------------------------- |
| `tensor.numpy()` | PyTorch (`torch.Tensor`) | åªèƒ½ç”¨äº **PyTorch Tensor**                  | æŠŠ tensor è½¬æ¢ä¸º numpy æ•°ç»„ | âœ… ä¼šå…±äº«å†…å­˜  | `torch.tensor([1,2]).numpy()` |
| `np.array(...)`  | NumPy                    | å¯ä»¥æ˜¯ `list`, `tuple`, `ndarray`, `Tensor` | æ„é€ æ–°çš„ numpy æ•°ç»„         | âŒ é€šå¸¸å¤åˆ¶æ•°æ® | `np.array([1, 2, 3])`         |
